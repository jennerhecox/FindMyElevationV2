---
// Landmark Comparison Component
// Displays the closest landmark to the current elevation
---

<div
  id="landmark-comparison"
  class="w-full max-w-lg mx-auto mt-4 p-5 bg-secondary-container text-on-secondary-container rounded-lg flex items-center gap-4 opacity-0 translate-y-5 transition-all duration-400"
  style="display: none;"
>
  <div class="w-24 h-24 flex-shrink-0 flex items-center justify-center bg-primary rounded-md overflow-hidden p-0" id="landmark-icon"></div>
  <div class="flex-1 min-w-0 overflow-hidden">
    <div class="font-semibold text-lg mb-1" id="landmark-name">Loading...</div>
    <div class="text-base opacity-90" id="landmark-elevation"></div>
  </div>
</div>

<style>
  /* Keep only visibility animation class */
  #landmark-comparison.visible {
    opacity: 1 !important;
    transform: translateY(0) !important;
  }
</style>

<script>
  import { getAllLandmarks } from '../lib/landmarks/data';
  import { findNearbyLandmarks, formatComparisonMessage } from '../lib/landmarks/matcher';
  import { metersToFeet, formatElevation } from '../lib/utils/units';

  interface LandmarkDisplayOptions {
    elevation: number; // in meters
    unit?: 'meters' | 'feet';
  }

  class LandmarkDisplay {
    private container: HTMLElement;
    private iconElement: HTMLElement;
    private nameElement: HTMLElement;
    private elevationElement: HTMLElement;

    constructor() {
      this.container = document.getElementById('landmark-comparison') as HTMLElement;
      this.iconElement = document.getElementById('landmark-icon') as HTMLElement;
      this.nameElement = document.getElementById('landmark-name') as HTMLElement;
      this.elevationElement = document.getElementById('landmark-elevation') as HTMLElement;
    }

    /**
     * Get SVG icon based on landmark type
     */
    private getIconForType(type: string): string {
      const icons: Record<string, string> = {
        mountain: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18L12 3 3 21zm9-6v3m0-3l3-3m-3 3l-3-3"/>
        </svg>`,
        tower: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>`,
        building: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>`,
        monument: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L8 8h8l-4-6zM8 8v12H6v2h12v-2h-2V8H8z"/>
        </svg>`,
        natural: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
        </svg>`,
        city: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
        </svg>`,
        structure: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M12 3l9 7H3l9-7z"/>
        </svg>`,
        site: `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>`,
      };
      return icons[type] || icons.site;
    }

    /**
     * Display landmark comparison
     */
    public display(options: LandmarkDisplayOptions): void {
      const { elevation, unit = 'meters' } = options;

      // Find 15 nearby landmarks and randomly select one
      const landmarks = getAllLandmarks();
      const nearbyLandmarks = findNearbyLandmarks(elevation, landmarks, 15, 1000);

      if (nearbyLandmarks.length === 0) {
        // No landmark found within tolerance
        this.container.style.display = 'none';
        return;
      }

      // Randomly select one from the nearby landmarks
      const randomIndex = Math.floor(Math.random() * nearbyLandmarks.length);
      const closest = nearbyLandmarks[randomIndex];

      // Display icon based on landmark type
      const iconSvg = this.getIconForType((closest as any).type || 'site');
      this.iconElement.innerHTML = iconSvg;
      this.nameElement.textContent = closest.name;

      const comparisonMessage = formatComparisonMessage(elevation, closest);

      // Format landmark elevation in current unit
      const landmarkElevation = unit === 'feet'
        ? metersToFeet(closest.elevation_meters)
        : closest.elevation_meters;
      const unitLabel = unit === 'feet' ? 'ft' : 'm';
      const elevationText = `${formatElevation(landmarkElevation)}${unitLabel} elevation`;

      this.elevationElement.innerHTML = `
        <div>${comparisonMessage}</div>
        <div style="margin-top: 0.25rem; font-size: 0.9em; opacity: 0.8;">${elevationText}</div>
      `;

      // Show with animation
      this.container.style.display = 'flex';

      // Trigger animation after a short delay
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          this.container.classList.add('visible');
        });
      });

      console.log('Landmark comparison:', closest);
    }

    /**
     * Hide landmark comparison
     */
    public hide(): void {
      this.container.classList.remove('visible');
      setTimeout(() => {
        this.container.style.display = 'none';
      }, 400);
    }
  }

  // Export for use in main page
  (window as any).LandmarkDisplay = LandmarkDisplay;
</script>
