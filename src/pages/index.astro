---
import Layout from '../layouts/Layout.astro';
import ElevationGauge from '../components/ElevationGauge.astro';
import LandmarkComparison from '../components/LandmarkComparison.astro';
import OfflineIndicator from '../components/OfflineIndicator.astro';
---

<Layout title="Find My Elevation">
  <!-- Desktop: 3-column grid with sidebar ads -->
  <div class="max-w-6xl mx-auto px-4 min-h-screen">
    <div class="md:grid md:grid-cols-[160px_1fr_160px] md:gap-6">

      <!-- Left sidebar ad (desktop only) -->
      <aside class="hidden md:block sticky top-4 self-start pt-20">
        <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-2699582258154063"
          data-ad-slot="LEFT_AD_SLOT"
          data-ad-format="vertical"
          data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </aside>

      <!-- Main content (center column) -->
      <div class="max-w-2xl mx-auto w-full flex flex-col items-center gap-3 text-center">
        <header class="text-center py-2 w-full">
          <h1 class="text-4xl font-bold text-primary flex items-center justify-center gap-3">
            Find My Elevation
            <svg class="w-10 h-10" viewBox="0 0 128 128">
              <path d="M64 25L95 80H33L64 25Z" fill="#89F8C7" stroke="#006C4C" stroke-width="3" stroke-linejoin="round"/>
              <path d="M40 80L55 58L70 70L85 48L110 80H40Z" fill="#006C4C" stroke="#006C4C" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </h1>
        </header>

        <main id="main-content">
          <div class="text-center w-full max-w-lg mx-auto p-6 bg-surface rounded-3xl shadow-lg">
            <div id="elevation-content">
              <div class="elevation-loading">
                <p>Requesting location permission...</p>
              </div>
            </div>
          </div>

          <!-- Mobile ad: above gauge -->
          <div class="md:hidden w-full max-w-lg mx-auto my-3">
            <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="ca-pub-2699582258154063"
              data-ad-slot="MOBILE_TOP_AD_SLOT"
              data-ad-format="horizontal"
              data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>

          <div id="gauge-container" class="w-full max-w-md mx-auto flex justify-center py-4" style="display: none;">
            <ElevationGauge />
          </div>

          <div id="landmark-container">
            <LandmarkComparison />
          </div>

          <!-- Mobile ads: bottom -->
          <div class="md:hidden w-full max-w-lg mx-auto my-3">
            <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="ca-pub-2699582258154063"
              data-ad-slot="MOBILE_BOTTOM_AD_SLOT_1"
              data-ad-format="horizontal"
              data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>
          <div class="md:hidden w-full max-w-lg mx-auto my-3">
            <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="ca-pub-2699582258154063"
              data-ad-slot="MOBILE_BOTTOM_AD_SLOT_2"
              data-ad-format="horizontal"
              data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>
        </main>
      </div>

      <!-- Right sidebar ad (desktop only) -->
      <aside class="hidden md:block sticky top-4 self-start pt-20">
        <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-2699582258154063"
          data-ad-slot="RIGHT_AD_SLOT"
          data-ad-format="vertical"
          data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </aside>

    </div>
  </div>

  <OfflineIndicator />
</Layout>

<script>
  import { getElevationWithProgress } from '../lib/elevation/detector';
  import { metersToFeet, formatElevation } from '../lib/utils/units';
  import { getUnitPreference, setUnitPreference } from '../lib/storage/preferences';
  import { getAllLandmarks } from '../lib/landmarks/data';
  import { findNearbyLandmarks } from '../lib/landmarks/matcher';

  // State
  let currentElevation: number | null = null;
  let currentUnit: 'meters' | 'feet' = getUnitPreference();
  let currentLandmark: any = null;

  // DOM elements
  const elevationContent = document.getElementById('elevation-content');

  // Update loading status
  function showStatus(message: string) {
    if (elevationContent) {
      elevationContent.innerHTML = `
        <div class="h-[120px] flex flex-col items-center justify-center gap-3">
          <div class="w-10 h-10 border-4 border-surface-variant border-t-primary rounded-full animate-spin"></div>
          <p class="text-on-surface">${message}</p>
        </div>
      `;
    }
  }

  // Show error
  function showError(message: string) {
    if (elevationContent) {
      elevationContent.innerHTML = `
        <div class="text-center p-4 bg-red-50 text-red-600 rounded-lg mt-4">
          <p class="font-bold">Unable to get elevation</p>
          <p class="mt-2">${message}</p>
          <button class="mt-4 px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primary-light transition" onclick="location.reload()">
            Try Again
          </button>
        </div>
      `;
    }
  }

  // Display elevation
  function displayElevation(elevationMeters: number) {
    currentElevation = elevationMeters;

    const displayValue = currentUnit === 'feet'
      ? metersToFeet(elevationMeters)
      : elevationMeters;

    const unitSuffix = currentUnit === 'feet' ? 'ft' : 'm';

    if (elevationContent) {
      elevationContent.innerHTML = `
        <div>
          <div class="text-8xl font-bold text-primary leading-tight my-2">
            ${formatElevation(displayValue)}${unitSuffix}
          </div>
          <div class="mt-4 w-full flex justify-center">
            <div class="units-toggle flex gap-2 bg-surface-variant p-1 rounded-lg">
              <button
                class="px-8 py-4 min-h-[64px] min-w-[140px] rounded-lg font-semibold text-xl transition-all ${currentUnit === 'feet' ? 'bg-primary text-white shadow-md' : 'bg-transparent text-on-surface-variant hover:bg-surface'}"
                data-unit="feet"
              >
                Feet
              </button>
              <button
                class="px-8 py-4 min-h-[64px] min-w-[140px] rounded-lg font-semibold text-xl transition-all ${currentUnit === 'meters' ? 'bg-primary text-white shadow-md' : 'bg-transparent text-on-surface-variant hover:bg-surface'}"
                data-unit="meters"
              >
                Meters
              </button>
            </div>
          </div>
        </div>
      `;

      // Add event listeners for unit toggle
      const toggleButtons = elevationContent.querySelectorAll('.units-toggle button');
      toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
          const unit = button.getAttribute('data-unit') as 'meters' | 'feet';
          currentUnit = unit;
          setUnitPreference(unit);
          if (currentElevation !== null) {
            // Re-render the elevation display (but keep the same landmark)
            const savedLandmark = currentLandmark;
            displayElevation(currentElevation);
            currentLandmark = savedLandmark; // Restore the same landmark

            // Update gauge with new unit and same landmark
            if ((window as any).ElevationGauge) {
              const gauge = new (window as any).ElevationGauge();
              gauge.update({
                elevation: currentElevation,
                unit: currentUnit,
                landmark: currentLandmark
              });
            }
          }
        });
      });
    }

    // Select a landmark first (so both gauge and display use the same one)
    const landmarks = getAllLandmarks();
    const nearbyLandmarks = findNearbyLandmarks(elevationMeters, landmarks, 15, 1000);
    if (nearbyLandmarks.length > 0) {
      const randomIndex = Math.floor(Math.random() * nearbyLandmarks.length);
      currentLandmark = nearbyLandmarks[randomIndex];
    } else {
      currentLandmark = null;
    }

    // Show and update gauge
    const gaugeContainer = document.getElementById('gauge-container');
    if (gaugeContainer && (window as any).ElevationGauge) {
      gaugeContainer.style.display = 'block';

      // Wait for gauge to be in DOM, then update
      setTimeout(() => {
        const gauge = new (window as any).ElevationGauge();
        gauge.update({
          elevation: elevationMeters,
          unit: currentUnit,
          landmark: currentLandmark
        });
      }, 100);
    }

    // Show landmark comparison (async, non-blocking)
    setTimeout(() => {
      if ((window as any).LandmarkDisplay && currentLandmark) {
        const landmarkDisplay = new (window as any).LandmarkDisplay();
        landmarkDisplay.displayWithLandmark({
          elevation: elevationMeters,
          unit: currentUnit,
          landmark: currentLandmark
        });
      }
    }, 500);
  }

  // Main initialization
  async function init() {
    try {
      showStatus('Requesting location permission...');

      const result = await getElevationWithProgress((status) => {
        showStatus(status);
      });

      console.log('Elevation result:', result);

      // Display elevation
      displayElevation(result.elevation);

      // Show additional info
      const sourceLabel = result.source === 'gps' ? 'GPS' :
                         result.source === 'cache' ? 'Cached data' :
                         'Network API';

      console.log(`Source: ${sourceLabel}, Accuracy: Â±${Math.round(result.accuracy)}m`);

    } catch (error: any) {
      console.error('Elevation detection failed:', error);

      let userMessage = error.message || 'An unknown error occurred.';

      if (error.message && error.message.includes('permission denied')) {
        userMessage = 'Location permission denied. Please enable location access in your browser settings and reload the page.';
      } else if (error.message && error.message.includes('not supported')) {
        userMessage = 'Your browser or device does not support location services.';
      }

      showError(userMessage);
    }
  }

  // Start the app
  init();
</script>
